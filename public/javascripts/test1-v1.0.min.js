!function(t){var e=document,a="appendChild",n="createElement",r="__defineGetter__",i="__defineSetter__";Array.hasOwnProperty("trim")||(Array.prototype.trim=function(){return this.filter(function(t,e,a){return!(void 0===t||null===t||""===t||0===t.qty)})});try{var o=new window.CustomEvent("test");if(o.preventDefault(),!0!==o.defaultPrevented)throw new Error("Could not prevent default")}catch(t){var s=function(t,e){var a,n;return e=e||{bubbles:!1,cancelable:!1,detail:void 0},(a=document.createEvent("CustomEvent")).initCustomEvent(t,e.bubbles,e.cancelable,e.detail),n=a.preventDefault,a.preventDefault=function(){n.call(this);try{Object.defineProperty(this,"defaultPrevented",{get:function(){return!0}})}catch(t){this.defaultPrevented=!0}},a};s.prototype=window.Event.prototype,window.CustomEvent=s}Element.prototype.addClass=function(t){var e=this;return t.replace(/ /gi,",").split(",").map(function(t){e.classList.contains(t)||e.classList.add(t)}),e},Element.prototype.removeClass=function(t){var e=this;return t.replace(/ /gi,",").split(",").map(function(t){e.classList.contains(t)&&e.classList.remove(t)}),0==e.classList.length&&e.removeAttribute("class"),e},Element.prototype.hasClass=function(t){return this.classList.contains(t)},Element.prototype.remove||(Element.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)}),Element.prototype.trigger||(Element.prototype.trigger=function(t,e){var a=this,n=t.replace(/ /gi,",").split(",");return void 0===e?n.map(function(t){var e=new s(t);a.dispatchEvent(e)}):n.map(function(t){var n=new s(t,e);a.dispatchEvent(n)}),a});var l=function(){this.salegroup,this.buygroup,this.loggroup};l.prototype.initialize=function(t){var r=e[n]("main"),i=e[n]("div");i.addClass("chart");var o=e[n]("div");o.addClass("monitor");var s=e[n]("div");s.addClass("call");var l=e[n]("div");l.addClass("trans");var c=e[n]("div");c.addClass("data-header call");var d=e[n]("span"),u=e[n]("p"),p=e[n]("p");u.innerText="매도수량",p.innerText="매도가격",d[a](u),d[a](p);var y=e[n]("span"),h=e[n]("p"),f=e[n]("p");h.innerText="매수가격",f.innerText="매수수량",y[a](h),y[a](f),c[a](d),c[a](y);var m=e[n]("div");m.addClass("data-list"),this.salegroup=e[n]("ul"),this.salegroup.addClass("sale"),this.buygroup=e[n]("ul"),this.buygroup.addClass("buy");var v=e[n]("div");v.addClass("data-header");var g=e[n]("span");g.style.setProperty("width","100%"),g.innerText="체결정보",v[a](g);var q=e[n]("div");q.addClass("data-list"),this.loggroup=e[n]("ul"),m[a](this.salegroup),m[a](this.buygroup),s[a](c),s[a](m),o[a](s),q[a](this.loggroup),l[a](v),l[a](q),o[a](l),r[a](i),r[a](o),document.body[a](r)};var c=function(){};c.prototype.initialize=function(){this.createChart()},c.prototype.createItem=function(t){var o=this,s=(o.data,(new Date).getTime()),l=e[n]("li"),c=e[n]("span"),d=e[n]("span"),u=e[n]("p"),p=e[n]("p"),y=o.sale_calc,h=o.buy_calc;return l.id=s,l[a](c),l[a](d),l[r]("index",function(){return t.no}),l[r]("price",function(){return t.price}),l[r]("qty",function(){return t.qty}),l[i]("price",function(t){u.innerText=t}),l[i]("qty",function(e){return t.qty!=e&&(p.innerText=t.qty=e,l.trigger("update")),e}),l.setAttribute("no",t.no),u.innerText=t.price,p.innerText=t.qty,l.pid=null,l.addEventListener("update",function(t){l.addClass("update"),0==l.qty&&l.addClass("remove"),null!=l.pid&&clearTimeout(l.pid),l.pid=setTimeout(function(){l.removeClass("update"),0==l.qty&&l.remove()},200)}),"S"==t.type?(c[a](p),c[a](u),l.addEventListener("sale",function(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),y.call(o,t,l)})):(d[a](u),d[a](p),l.addEventListener("buy",function(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),h.call(o,t,l)})),l},c.prototype.createTransaction=function(t){var r=t.qty,o=e[n]("li"),s=e[n]("div"),l=e[n]("span"),c=e[n]("span"),d=e[n]("div");return l.innerText=t.no+"초",c.innerText=("B"==t.type?"매수":"매도")+": 가격 "+t.price+" / 수량 "+r,o[i]("result",function(t){c.innerText+=" ( 체결: "+(r-t)+")"}),o[i]("log",function(t){""!=d.innerText&&d[a](e[n]("br")),d[a](e.createTextNode("  - "+("B"==t.type?"매수":"매도")+": 가격 "+t.price+"/수량 "+t.qty))}),s[a](l),s[a](c),o[a](s),o[a](d),o},c.prototype.createChart=function(){var t=this.data,a=8,n=8,r=28,i=8,o=Math.round(document.documentElement.clientWidth),s=Math.round(.2*document.documentElement.clientHeight),l=o-i-n,c=s-a-r,d=e.querySelector(".chart"),u=d3.select(d).append("svg").attr("width",o).attr("height",s),p=d3.scaleLinear().domain([1,59]).range([i,l]),y=d3.scaleLinear().domain([0,0]).range([c,a]),h=d3.axisRight(y).ticks(2),f=d3.axisBottom(p).ticks(10),m=d3.line().x(function(t){return p(t.x)}).y(function(t){return y(t.y)});u.append("g").attr("class","y-axis").attr("transform","translate("+i+","+a+")").call(h),u.append("g").attr("class","x-axis").attr("transform","translate(0,"+(c+a)+")").call(f);var v=u.append("g").attr("transform","translate(0,"+a+")");return v.append("path"),d.addEventListener("update",function(e){var n=d3.max(t.c_data.map(function(t){return t.y}));y=d3.scaleLinear().domain([0,n]).range([c,a]).nice(),h=d3.axisRight(y).ticks(2),u.selectAll(".y-axis").transition().call(h),m=d3.line().x(function(t){return p(t.x)}).y(function(t){return y(t.y)}),v.selectAll("path").datum(t.c_data).transition().attr("class",function(t,e){return"path d-"+e}).attr("fill","none").attr("stroke","steelblue").attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("d",m),v.selectAll(".qty").attr("style","opacity:0;transition: 100ms linear").data(t.c_data).attr("transform",function(t){return"translate("+(p(t.x)-14)+","+(y(t.y)-8)+")"}).attr("dx",".71em").attr("dy",".35em").attr("style",function(t){return 0==t.y?"opacity:0;transition: 100ms linear":"opacity:1;font-size:12px;transition: all 800ms cubic-bezier(0.9, 0.85, 0.05, 0.01);"}).enter().append("text").attr("class","qty").attr("transform",function(t){return"translate("+(p(t.x)-14)+","+(y(t.y)-8)+")"}).attr("dx",".71em").attr("dy",".35em").attr("style",function(t){return 0==t.y?"opacity:0;transition: 100ms linear":"opacity:1;font-size:12px;transition: all 800ms cubic-bezier(0.9, 0.85, 0.05, 0.01);"}).text(function(t){return t.y})}),d};var d=function(){this.layouts,this.components,this.data={b_data:[],s_data:[],c_data:[]},this.socket=null};d.prototype.initialize=function(){var t=this,e=t.layouts;t.socket=io(),t.socket.on("data",function(a){if(void 0!==a&&void 0!==a.type){if(1==a.no){var n;for(n=e.salegroup.childElementCount-1;n>-1;n--)e.salegroup.childNodes[n].remove();for(n=e.buygroup.childElementCount-1;n>-1;n--)e.buygroup.childNodes[n].remove();for(n=e.loggroup.childElementCount-1;n>-1;n--)e.loggroup.childNodes[n].remove();t.data.b_data=[],t.data.s_data=[],t.data.c_data=[]}t.createItem(a)}})},d.prototype.createItem=function(t){var e="B"==t.type?"buy":"sale",n=this.layouts,r=this.components,i=this.data,o=r.createItem(t);t.id=o.id,i[t.type.toLowerCase()+"_data"].push(t),n[e+"group"][a](o),o.trigger(e)},d.prototype.buy=function(t,e){var n=this.data,r=JSON.parse(JSON.stringify(t)),i=[],o=this.data.s_data.filter(function(e){return e.price<=t.price&&0!=e.qty});if(o.length>0){o.sort(function(t,e){return t.price==e.price?e.qty-t.qty:t.price-e.price});for(var s=0;s<o.length&&t.qty>0;s++){var l=document.getElementById(o[s].id);i.push(JSON.parse(JSON.stringify(o[s]))),l.qty>t.qty?(l.qty=l.qty-t.qty,e.qty=0):(e.qty=e.qty-l.qty,l.qty=0)}n.s_data=n.s_data.trim(),n.b_data=n.b_data.trim(),n.c_data.push({x:t.no,y:r.qty-e.qty});var c=this.createTransaction(r);i.forEach(function(t){c.log=t}),this.layouts.loggroup[a](c),c.result=e.qty}else n.c_data.push({x:t.no,y:0});document.querySelector("div.chart").trigger("update")},d.prototype.sale=function(t,e){var n=this.data,r=JSON.parse(JSON.stringify(t)),i=[],o=this.data.b_data.filter(function(e){return e.price>=t.price&&e.qty>0});if(o.length>0){o.sort(function(t,e){return t.price==e.price?e.qty-t.qty:e.price-t.price});for(var s=0;s<o.length&&t.qty>0;s++){var l=document.getElementById(o[s].id);i.push(JSON.parse(JSON.stringify(o[s]))),l.qty>t.qty?(l.qty=l.qty-t.qty,e.qty=0):(e.qty=e.qty-l.qty,l.qty=0)}n.b_data=n.b_data.trim(),n.s_data=n.s_data.trim(),n.c_data.push({x:t.no,y:r.qty-e.qty});var c=this.createTransaction(r);i.forEach(function(t){c.log=t}),this.layouts.loggroup[a](c),c.result=e.qty}else n.c_data.push({x:t.no,y:0});document.querySelector("div.chart").trigger("update")};var u=function(){this.construct={name:"core",version:"1.0"},this.layouts=new l,this.components=new c,this.model=new d,this.layouts.data=this.model.data,this.components.data=this.model.data,this.components.layouts=this.layouts,this.components.sale_calc=this.model.sale,this.components.buy_calc=this.model.buy,this.model.layouts=this.layouts,this.model.components=this.components};u.prototype.initialize=function(){this.layouts.initialize(),this.components.initialize(),this.model.initialize()};var p=new u;t.addEventListener("load",function(t){p.initialize()})}(window);